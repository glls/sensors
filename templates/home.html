<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-4">
    <h1 class="text-center">Welcome to the Sensors Project</h1>
    <p class="text-center"><strong>Connected Clients:</strong> {{ client_count }}</p>

    <div class="row">
        <!-- Card 1: Latest Outdoor Sensor Reading -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">Latest Outdoor Sensor Reading</div>
                <div class="card-body">
                    {% if latest_air_data %}
                        <p><strong>Sensor ID:</strong> {{ latest_air_data.sensor_id }}</p>
                        <p><strong>PM10:</strong> {{ latest_air_data.p1 }} µg/m³</p>
                        <p><strong>PM2.5:</strong> {{ latest_air_data.p2 }} µg/m³</p>
                        <p><strong>Temperature:</strong> {{ latest_air_data.temperature }} °C</p>
                        <p><strong>Humidity:</strong> {{ latest_air_data.humidity }} %</p>
                        <p><strong>Pressure:</strong> {{ latest_air_data.pressure }} hPa</p>
                        <p><strong>Signal:</strong> {{ latest_air_data.signal }} dBm</p>
                        <p><strong>Time:</strong> {{ latest_air_data.time }}</p>
                    {% else %}
                        <p>No outdoor data available.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Card 2: Latest Indoor Sensor Reading -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">Latest Indoor Sensor Reading (ens160)</div>
                <div class="card-body">
                    {% if latest_indoor_data %}
                        <p><strong>Sensor ID:</strong> {{ latest_indoor_data.sensor_id }}</p>
                        <p><strong>AQI:</strong> {{ latest_indoor_data.aqi }}</p>
                        <p><strong>TVOC:</strong> {{ latest_indoor_data.tvoc }}</p>
                        <p><strong>eCO2:</strong> {{ latest_indoor_data.eco2 }}</p>
                        <p><strong>Time:</strong> {{ latest_indoor_data.time }}</p>
                    {% else %}
                        <p>No indoor data available.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Card 3: Latest Temperature Data (Sensor 1) -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">Latest Temperature Data (Sensor 1)</div>
                <div class="card-body">
                    {% if latest_temp_sensor_1 %}
                        <p><strong>Temperature:</strong> {{ latest_temp_sensor_1.temperature }} °C</p>
                        <p><strong>Humidity:</strong> {{ latest_temp_sensor_1.humidity }} %</p>
                        <p><strong>Pressure:</strong> {{ latest_temp_sensor_1.pressure }} hPa</p>
                        <p><strong>Time:</strong> {{ latest_temp_sensor_1.time }}</p>
                    {% else %}
                        <p>No temperature data available for Sensor 1.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Card 4: Latest Temperature Data (Sensor 2) -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">Latest Temperature Data (Sensor 2)</div>
                <div class="card-body">
                    {% if latest_temp_sensor_2 %}
                        <p><strong>Temperature:</strong> {{ latest_temp_sensor_2.temperature }} °C</p>
                        <p><strong>Humidity:</strong> {{ latest_temp_sensor_2.humidity }} %</p>
                        <p><strong>Time:</strong> {{ latest_temp_sensor_2.time }}</p>
                    {% else %}
                        <p>No temperature data available for Sensor 2.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

    // Define WebSocket connections for all sensors
    const sensorIds = [
        {% if latest_air_data %}{{ latest_air_data.sensor_id }}, {% endif %}
        {% if latest_indoor_data %}{{ latest_indoor_data.sensor_id }}, {% endif %}
        {% if latest_temp_sensor_1 %}{{ latest_temp_sensor_1.sensor_id }}, {% endif %}
        {% if latest_temp_sensor_2 %}{{ latest_temp_sensor_2.sensor_id }}, {% endif %}
    ];

    const sockets = {};

    // Create WebSocket connections for each sensor
    sensorIds.forEach(sensorId => {
        sockets[sensorId] = new WebSocket('ws://' + window.location.host + '/ws/sensor_data/' + sensorId + '/');

        sockets[sensorId].onmessage = function (event) {
            const data = JSON.parse(event.data);
            console.log('Received data for sensor ID:', sensor_id, data);

            // Update the DOM based on the sensor ID
            if (data.sensor_id === {{ latest_air_data.sensor_id|default:0 }}) {
                document.getElementById('sensor-id').textContent = data.sensor_id;
                document.getElementById('pm10').textContent = data.pm10 + ' µg/m³';
                document.getElementById('pm25').textContent = data.pm25 + ' µg/m³';
                document.getElementById('temperature').textContent = data.temperature + ' °C';
                document.getElementById('humidity').textContent = data.humidity + ' %';
                document.getElementById('pressure').textContent = data.pressure + ' hPa';
                document.getElementById('signal').textContent = data.signal + ' dBm';
                document.getElementById('time').textContent = data.time;
            } else if (data.sensor_id === {{ latest_indoor_data.sensor_id|default:0 }}) {
                document.getElementById('sensor-id').textContent = data.sensor_id;
                document.getElementById('aqi').textContent = data.aqi;
                document.getElementById('tvoc').textContent = data.tvoc;
                document.getElementById('eco2').textContent = data.eco2;
                document.getElementById('time').textContent = data.time;
            } else if (data.sensor_id === {{ latest_temp_sensor_1.sensor_id|default:0 }}) {
                document.getElementById('temperature').textContent = data.temperature + ' °C';
                document.getElementById('humidity').textContent = data.humidity + ' %';
                document.getElementById('pressure').textContent = data.pressure + ' hPa';
                document.getElementById('time').textContent = data.time;
            } else if (data.sensor_id === {{ latest_temp_sensor_2.sensor_id|default:0 }}) {
                document.getElementById('temperature').textContent = data.temperature + ' °C';
                document.getElementById('humidity').textContent = data.humidity + ' %';
                document.getElementById('time').textContent = data.time;
            }
        };
    });
</script>


</body>
</html>